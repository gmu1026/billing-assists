name: HB Cookie Keep-Alive

# ëª©ì : 1ì‹œê°„ë§ˆë‹¤ ê°€ë²¼ìš´ API í˜¸ì¶œë¡œ ì¿ í‚¤ ë§Œë£Œ ë°©ì§€
# HB ì¿ í‚¤ëŠ” ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë°©ì‹ìœ¼ë¡œ API í˜¸ì¶œ ì‹œ ìë™ ê°±ì‹ ë¨

on:
  schedule:
    # 1ì‹œê°„ë§ˆë‹¤ (ë§¤ ì •ê°)
    - cron: '0 * * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install dependencies
        run: pip install requests

      - name: Keep cookies alive
        env:
          ALIBABA_COOKIE: ${{ secrets.ALIBABA_COOKIE }}
          AKAMAI_COOKIE: ${{ secrets.AKAMAI_COOKIE }}
          GCP_COOKIE: ${{ secrets.GCP_COOKIE }}
        run: |
          python - <<'EOF'
          import os
          import requests
          from datetime import datetime
          
          CSP_CONFIGS = {
              "alibaba": "https://alibabacloud.hyperbilling.kr/admin/api/v1/iam/company?status=1",
              "akamai": "https://akamai.hyperbilling.kr/admin/api/v1/iam/company?status=1",
              "gcp": "https://gcp.hyperbilling.kr/admin/api/v1/iam/company?status=1"
          }
          
          print(f"\n{'='*70}")
          print(f"ğŸ”„ ì¿ í‚¤ Keep-Alive")
          print(f"ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}")
          print(f"{'='*70}\n")
          
          for csp, url in CSP_CONFIGS.items():
              cookie = os.getenv(f'{csp.upper()}_COOKIE')
              
              if not cookie:
                  print(f"âš ï¸  [{csp.upper()}] ì¿ í‚¤ ì—†ìŒ - ìŠ¤í‚µ")
                  continue
              
              try:
                  response = requests.get(
                      url,
                      headers={'Cookie': f'connect.sid={cookie}'},
                      timeout=30
                  )
                  
                  if response.status_code == 200:
                      set_cookie = response.headers.get('Set-Cookie')
                      if set_cookie and 'Expires=' in set_cookie:
                          expires = set_cookie.split('Expires=')[1].split(';')[0]
                          print(f"âœ… [{csp.upper()}] ì¿ í‚¤ ê°±ì‹  ì™„ë£Œ")
                          print(f"   ë§Œë£Œ: {expires}")
                      else:
                          print(f"âœ… [{csp.upper()}] API í˜¸ì¶œ ì„±ê³µ")
                  elif response.status_code == 401:
                      print(f"âŒ [{csp.upper()}] ì¿ í‚¤ ë§Œë£Œ (401) - Secrets ì—…ë°ì´íŠ¸ í•„ìš”")
                      print(f"::error::CSP {csp} ì¿ í‚¤ ê°±ì‹  í•„ìš”")
                  else:
                      print(f"âš ï¸  [{csp.upper()}] HTTP {response.status_code}")
                      
              except Exception as e:
                  print(f"âŒ [{csp.upper()}] ì—ëŸ¬: {e}")
              
              print()
          
          print(f"{'='*70}\n")
          EOF