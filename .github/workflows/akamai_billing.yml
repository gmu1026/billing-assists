name: Akamai Billing Pipeline

on:
  # 매일 00:00 UTC (KST 09:00)
  schedule:
    - cron: '0 0 * * *'

  # 수동 실행
  workflow_dispatch:
    inputs:
      billing_month:
        description: 'Billing Month (YYYY-MM, 빈칸=자동 전월)'
        required: false
        default: ''

jobs:
  billing-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run Akamai Billing Pipeline
        env:
          PYTHONPATH: .
          AKAMAI_CLIENT_ID: ${{ secrets.AKAMAI_CLIENT_ID }}
          AKAMAI_CLIENT_TOKEN: ${{ secrets.AKAMAI_CLIENT_TOKEN }}
          AKAMAI_CLIENT_SECRET: ${{ secrets.AKAMAI_CLIENT_SECRET }}
          AKAMAI_ACCESS_TOKEN: ${{ secrets.AKAMAI_ACCESS_TOKEN }}
          AKAMAI_BASE_URL: ${{ secrets.AKAMAI_BASE_URL }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          BQ_SA_KEY: ${{ secrets.BQ_SA_KEY }}
          BQ_PROJECT: ${{ secrets.BQ_PROJECT }}
          BQ_DATASET: ${{ secrets.BQ_DATASET }}
          BILLING_MONTH: ${{ github.event.inputs.billing_month }}
          WEBHOOK_URL_AKAMAI_BILLING: ${{ secrets.WEBHOOK_URL_AKAMAI_BILLING }}
        run: uv run python tasks/akamai_billing/main.py
